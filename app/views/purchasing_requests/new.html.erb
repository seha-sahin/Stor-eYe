<%= form_with model: @purchasing_request, url: purchasing_requests_path do |f| %>
  <% if @purchasing_request.errors.any? %>
    <div id="error_explanation" class="alert alert-danger">
      <h2><%= pluralize(@purchasing_request.errors.count, "error") %> prohibited this purchasing request from being saved:</h2>

      <ul>
        <% @purchasing_request.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :supplier_id, class: 'form-label' %>
    <%= f.collection_select :supplier_id, @suppliers, :id, :name, { prompt: 'Select a supplier' }, { class: 'form-control' } %>
  </div>

  <% @wines_by_supplier.each do |supplier_id, wines| %>
    <div class="form-group">
      <%= label_tag "Supplier #{supplier_id} Wines", class: 'form-label' %>
      <%= f.fields_for :purchasing_request_items do |item_form| %>
        <% wines.each do |wine| %>
          <% item = @purchasing_request.purchasing_request_items.find_by(wine_id: wine.id) || item_form.object || item_form.object = PurchasingRequestItem.new(wine: wine) %>
          <% if item.quantity.nil? %>
            <% item.quantity = 0 %>
          <% end %>

          <% if item.persisted? %>
            <%= item_form.hidden_field :id, value: item.id %>
          <% end %>

          <% label_text = "#{wine.maker}" %>
          <div class="form-check">
            <%= item_form.check_box :_destroy, class: 'form-check-input', id: "purchasing_request_items_#{item.id}_destroy", checked: item._destroy %>
            <%= label_tag "purchasing_request_items_#{item.id}_quantity", label_text, class: 'form-check-label' %>
            <%= number_field_tag "purchasing_request_items[#{wine.id}][quantity]", item.quantity, class: 'form-control', min: 0 %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :delivery_date, class: 'form-label' %>
    <%= f.date_select :delivery_date, { class: 'form-control' } %>
  </div>

  <div class="form-group">
    <%= f.label :delivery_time_slot, class: 'form-label' %>
    <%= f.text_field :delivery_time_slot, { class: 'form-control' } %>
  </div>

  <div class="actions">
    <%= f.submit 'Create Purchasing request', class: 'btn btn-primary' %>
  </div>
<% end %>
